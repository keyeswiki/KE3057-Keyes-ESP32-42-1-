# 第五十课 电位器调节灯光亮度

## 1.1 项目介绍

从前面的课程实验中我们学习了设计呼吸灯和按键控制LED灯。在这一实验课程中我们尝试将呼吸灯和按键控制LED灯这两个实验现象组合起来，用可调电位器代替按键，实现利用旋转可调电位器读取到的模拟值控制紫色LED亮度的效果。可调电位器模拟值的范围是0 ~ 4095；LED的亮度由PWM值控制，范围为0 ~ 255。

---

## 1.2 实验组件

| ![img](media/KS5016.png) | ![img](media/KE4030.png)  | ![img](media/KE4001.png) | ![img](media/3pin.jpg)       | ![img](media/USB.jpg) |
| ------------------------ | ------------------------- | ------------------------ | ---------------------------- | --------------------- |
| ESP32 Plus主板 x1        | Keyes 旋转电位器传感器 x1 | Keyes 紫色LED模块 x1     | XH2.54-3P 转杜邦线母单线  x2 | USB线  x1             |

---

## 1.3 模块接线图

![img](media/501301.png)

---

## 1.4 实验代码

本项目中使用的代码保存在文件夹“<u>**/home/pi/代码**</u>”中，我们可以在此路径下打开代码文件''**adjust_the_light.ino**"。

**注意：为了避免上传代码不成功，请上传代码前不要连接模块。代码上传成功后，拔下USB线断电，按照接线图正确接好模块后再用USB线连接到树莓派上电，观察实验结果。**

```c++
/*  
 * 名称   : adjust the light
 * 功能   : 通过电位器控制LED的亮度
 * 作者   : http://www.keyes-robot.com/
*/
#define PIN_ANALOG_IN    34  //电位器的引脚
#define PIN_LED           5  // LED的引脚
#define CHANNEL           0  // 使用led通道0

void setup() {
  ledcSetup(CHANNEL, 1000, 12);     // PWM取值范围为0 ~ 4096
  ledcAttachPin(PIN_LED, CHANNEL);  // PIN_LED引脚定义为通道0的输出引脚
}

void loop() {
  ledcWrite(CHANNEL, analogRead(PIN_ANALOG_IN));   // 设置累计脉冲宽度
  delay(10);
}
```

ESP32主板通过USB线连接到树莓派后开始上传代码。为了避免将代码上传至ESP32主板时出现错误，必须选择与树莓派连接正确的控制板和串行端口。

单击![img](media/wps17.jpg)将代码上传到ESP32主控板，等待代码上传成功后查看实验结果。

---

## 1.5 实验结果

代码上传成功后，拔下USB线断电，按照接线图正确接好模块后再用USB线连接到树莓派上电。旋转电位器，可以调节紫色LED的亮度。

![](media/501501.png)

![](media/501502.png)

---

## 1.6 代码说明

| 代码                                                         | 说明                                                         |
| ------------------------------------------------------------ | ------------------------------------------------------------ |
| double ledcSetup(uint8_t chan, double freq, uint8_t bit_num) | 第一个参数 chan 表示通道号，取值为0 ~ 15即可设置16个通道，其中高速通道（0 ~ 7）由80MHz时钟驱动，低速通道（8 ~ 15）由 1MHz 时钟驱动；第二个参数 freq 为期望设置的频率；第三个参数为占空比分辨率的计数位数，其取值为0 ~ 20（该值决定后面 ledcWrite 函数中占空比可写值，比如该值写10，那么PWM的刻度范围就是0 ~ 2^10^，也就是0 ~ 1024，则占空比最大可写1023（2^10^ - 1） 即占空比范围为0 ~ 1023）。 |
| ledcSetup(CHANNEL, 1000, 12)                                 | 从上面的ledcSetup()函数的原型说明我们可以知道实验中使用ledc通道0。设置频率为1000 Hz。分辨率为12位，那么PWM刻度范围就是0 ~ 2^12^，也就是0 ~ 4096，占空比范围为0 ~ 4095（）。 |
| ledcAttachPin(PIN_LED,  CHANNEL)                             | PIN_LED引脚（IO 4）定义为通道0的输出引脚。                   |
| ledcWrite(CHANNEL, analogRead(PIN_ANALOG_IN)                 | 设置ledc通道0的输出占空比。将可调电位器读取到的模拟值（范围是0 ~ 4095）设置为ledc通道0（范围是0 ~ 4095）的输出占空比，控制紫色LED的亮度。 |

 
